<!DOCTYPE html>
<html>
  <head>
    <%- include('../partials/head') %>
  </head>
  <body>
    <%- include('../partials/header') %>
    <div class="container">
      <h1>Analytics</h1>

      <h2>Course Analytics</h2>
      <div class="container">
        <div class="row">
          <svg width="550" height="500">
            <div id="svg"></div>
          </svg>
        </div>
        <div class="row">
          <div id="pieChart"></div>
        </div>
      </div>

      <h2>Student Analytics</h2>
      <ul class="list-group">
      <% students.forEach(function (student) { %>
        <li class="list-group-item">
          <a href="/courseInstance/<%= courseInstance.id %>/analytics/student/<%= student.id %>">
            <%= student.uin %>
          </a>
        </li>
      <% }) %>
      </ul>
    </div>
  </body>
  <script src="https://d3js.org/d3.v5.min.js"  charset="utf-8"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.7.2/d3.min.js" charset="utf-8"></script>
  <script src="/js/d3pie.min.js" charset="utf-8"></script>
  <script>
  var pie = new d3pie("pieChart", {
    "header": {
      "title": {
        "text": "Comparing Student Demographics",
        "fontSize": 20,
        "font": "open sans"
      },
      "subtitle": {
        "text": "See how this course's students' compare by major",
        "color": "#999999",
        "fontSize": 12,
        "font": "open sans"
      },
      "titleSubtitlePadding": 9
    },
    "footer": {
      "color": "#999999",
      "fontSize": 10,
      "font": "open sans",
      "location": "bottom-left"
    },
    "size": {
      "canvasWidth": 550,
      "pieOuterRadius": "96%"
    },
    "data": {
      "sortOrder": "value-desc",
      "content": [
        <% pieContent.forEach(function(obj) { %>
          {
            "label": "<%= obj.label %>",
            "value": <%= obj.value %>,
            "color": "<%= obj.color %>",
          },
        <% }) %>
      ]
    },
    "labels": {
      "outer": {
        "pieDistance": 32
      },
      "mainLabel": {
        "fontSize": 11
      },
      "percentage": {
        "color": "#ffffff",
        "decimalPlaces": 0
      },
      "value": {
        "color": "#adadad",
        "fontSize": 11
      },
      "lines": {
        "enabled": true
      },
      "truncation": {
        "enabled": true
      }
    },
    "effects": {
      "pullOutSegmentOnClick": {
        "effect": "linear",
        "speed": 400,
        "size": 8
      }
    },
    "misc": {
      "gradient": {
        "enabled": true,
        "percentage": 100
      }
    }
  });
</script>
<script>
var svg     = new d3.select("svg"),
      margin  = {top: 20, right: 20, bottom: 30, left: 50},
      width   = +svg.attr("width")  - margin.left - margin.right,
      height  = +svg.attr("height") - margin.top  - margin.bottom,
      x       = d3.scaleBand().rangeRound([0, width]).padding(0.2),
      y       = d3.scaleLinear().rangeRound([height, 0]),
      g       = svg.append("g")
                   .attr("transform", `translate(${margin.left},${margin.top})`);

content =
      [
          <% barContent.forEach(function(obj) { %>
            {
              "major": "<%= obj.major %>",
              "attendencerate": "<%= obj.attendencerate %>",
            },
          <% }) %>
        ];

x.domain(content.map(d => d.major));
y.domain([0,105]);// d3.max(content, d => d.attendencerate)]);

g.append("g")
  .attr("class", "axis axis-x")
  .attr("font-weight", "bold")
  .attr("transform", `translate(0,${height - 25})`)
  .call(d3.axisBottom(x));

g.append("g")
  .attr("class", "axis axis-y")
  .attr("transform", `translate(0,-25)`)
  .attr("font-weight", "bold")
  .call(d3.axisLeft(y).ticks(10).tickSize(8));

g.append('text')
      .attr('class', 'label')
      .attr('x', -(height / 2))
      .attr('y',  -(margin.left)/1.3)
      .attr('transform', 'rotate(-90)')
      .attr('text-anchor', 'middle')
      .text('Average Attendance Rate (%)');

g.append('text')
      .attr('class', 'label')
      .attr('x', width / 2)
      .attr('y', height + (margin.bottom)/1.7)
      .attr('text-anchor', 'middle')
      .text('Majors');

g.selectAll(".bar")
  .data(content)
  .enter().append("rect")
  .attr("class", "bar")
  .attr("fill", "#71EEB8")
  .attr("x", d => x(d.major))
  .attr("y", d => y(d.attendencerate)-25)
  .attr("width", x.bandwidth())
  .attr("height", d => height - y(d.attendencerate))
  .on("mouseover", function() {
  d3.select(this)
    .attr("fill", "slateblue");
})
  .on("mouseout", function() {
  d3.select(this)
    .attr("fill", "#71EEB8");
});
</script>

</html>
